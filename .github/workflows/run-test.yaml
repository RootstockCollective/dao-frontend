name: Trigger DAO Dapp Automation Workflow

on: 
  pull_request:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: "Environment to run the tests in"
        required: true
        default: "CR-QA"
        type: string
      TEST_TYPE:
        description: "Type of test to run (smoke, regression)"
        required: true
        default: "smoke"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Start E2E tests in target repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DAO_DAPP_AUTOMATION_PAT }}
          script: |
            const environment = process.env.ENVIRONMENT || 'CR-QA';
            const testType = process.env.TEST_TYPE || 'smoke';

            await github.request('POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches', {
              owner: 'rsksmart',
              repo: 'Deprecated_DAO-dApp-automation',
              workflow_id: 'playwright.yml',
              ref: 'main',
              inputs: {
                ENVIRONMENT: environment,
                TEST_TYPE: testType
              }
            });
        env:
          ENVIRONMENT: ${{ github.event.inputs.ENVIRONMENT || 'CR-QA' }}
          TEST_TYPE: ${{ github.event.inputs.TEST_TYPE || 'smoke' }}

        
        // wait briefly for the workflow to be queued
        await new Promise(resolve => setTimeout(resolve, 10000));

        const runs = await github.request('GET /repos/rsksmart/Deprecated_DAO-dApp-automation/actions/runs', {
          per_page: 1,
          event: 'workflow_dispatch'
        });

        const runId = runs.data.workflow_runs[0].id;
        core.setOutput('run_id', runId);

      - name: Poll E2E workflow run status
        run: |
          run_id=${{ steps.trigger.outputs.run_id }}

          echo "Polling workflow run ID: $run_id"

          status="in_progress"
          conclusion=""

          while [[ "$status" != "completed" ]]; do
            sleep 15
            response=$(curl -s -H "Authorization: Bearer ${{ secrets.DAO_DAPP_AUTOMATION_PAT }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/rsksmart/Deprecated_DAO-dApp-automation/actions/runs/$run_id)

            status=$(echo "$response" | jq -r .status)
            conclusion=$(echo "$response" | jq -r .conclusion)

            echo "Status: $status, Conclusion: $conclusion"
          done

          if [[ "$conclusion" != "success" ]]; then
            echo "❌ E2E tests failed with conclusion: $conclusion"
            exit 1
          else
            echo "✅ E2E tests passed successfully!"
          fi
