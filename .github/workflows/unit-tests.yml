name: Unit tests

on: push

# Declare default permissions as read only.
permissions: read-all

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
    - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 #v4.4.0
      with:
        node-version-file: '.nvmrc'

    - name: Install modules
      run: npm ci

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: stable

    - name: Start Anvil Fork
      run: |
        # Start Anvil fork in background for swap execution tests
        # Fork is required for testing swap execution (write operations) without spending real funds
        anvil --fork-url https://public-node.rsk.co --chain-id 31337 > /tmp/anvil.log 2>&1 &
        echo $! > /tmp/anvil.pid
        # Wait for fork to be ready (with timeout)
        timeout=30
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -s -X POST http://127.0.0.1:8545 -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' > /dev/null 2>&1; then
            echo "✅ Fork is ready!"
            break
          fi
          sleep 1
          counter=$((counter + 1))
        done
        if [ $counter -eq $timeout ]; then
          echo "❌ Fork failed to start within $timeout seconds"
          cat /tmp/anvil.log
          exit 1
        fi

    - name: Run tests
      env:
        FORK_RPC_URL: http://127.0.0.1:8545
      run: npm run test

    - name: Stop Anvil
      if: always()
      run: |
        if [ -f /tmp/anvil.pid ]; then
          kill $(cat /tmp/anvil.pid) 2>/dev/null || true
        fi
        pkill -f anvil 2>/dev/null || true
